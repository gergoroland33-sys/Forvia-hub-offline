<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORVIA | Staff Pro 2026 - MultiShift</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        /* SZÍNEK IGAZÍTÁSA A MASTER SHELLHEZ */
        :root {
            --bg-main: #0b1120;
            --card-bg: #1e293b;
            --accent-blue: #3b82f6;
            --text-gray: #94a3b8;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: #e2e8f0; margin: 0; }
        .table-container { overflow-x: auto; border-radius: 12px; background: #111827; border: 1px solid #334155; }
        
        /* Sticky oszlop igazítása */
        .name-col { position: sticky; left: 0; background: #1e293b; z-index: 40; min-width: 160px; border-right: 2px solid var(--accent-blue) !important; padding: 0 8px !important; }
        
        .matrix-table th, .matrix-table td { border: 1px solid #2d3748; min-width: 38px; height: 38px; text-align: center; font-size: 12px; }
        
        /* Kiemelések */
        .weekend { background: rgba(30, 41, 59, 0.5) !important; color: #64748b; }
        .holiday { background: #4c0505 !important; color: #fca5a5 !important; }
        .today-cell { border: 2px solid var(--accent-blue) !important; background: rgba(59, 130, 246, 0.1) !important; }
        
        /* Cellák stílusai */
        .cell-S { background: #059669 !important; color: white !important; font-weight: 900; }
        .cell-BA { background: #ea580c !important; }
        .cell-IG { background: #7c3aed !important; }
        .cell-TU { background: #2563eb !important; }
        .cell-KE { background: #d97706 !important; }

        .input-cell { width: 100%; height: 100%; border: none; text-align: center; background: transparent; color: white; font-weight: 700; outline: none; }
        
        header { background: #111827; border-bottom: 1px solid #334155; }
        .shift-btn { border: 1px solid #334155; color: var(--text-gray); }
        .shift-btn.active { color: white; background: var(--accent-blue); border-color: var(--accent-blue); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }

        @media print { .no-print { display: none !important; } #print-area { display: block !important; } }
    </style>
</head>
<body class="pb-10">
    <div id="print-area" class="hidden"></div>

    <header class="p-3 sticky top-0 z-50 no-print">
        <div class="max-w-full mx-auto flex flex-wrap justify-between items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="flex flex-col">
                    <span class="text-blue-500 font-black text-xl tracking-tighter">FORVIA</span>
                    <span id="shiftTitle" class="text-[10px] text-slate-400 font-bold uppercase">MŰSZAK: A</span>
                </div>
                <div class="flex bg-slate-900 p-1 rounded-lg gap-1">
                    <button onclick="changeShift('A')" id="btn-shift-A" class="shift-btn px-3 py-1 rounded text-[10px] font-black uppercase">A</button>
                    <button onclick="changeShift('B')" id="btn-shift-B" class="shift-btn px-3 py-1 rounded text-[10px] font-black uppercase">B</button>
                    <button onclick="changeShift('C')" id="btn-shift-C" class="shift-btn px-3 py-1 rounded text-[10px] font-black uppercase">C</button>
                    <button onclick="changeShift('D')" id="btn-shift-D" class="shift-btn px-3 py-1 rounded text-[10px] font-black uppercase">D</button>
                </div>
            </div>

            <div class="flex items-center gap-2 bg-slate-900 border border-slate-700 px-3 py-1 rounded-lg">
                <button onclick="changeMonth(-1)" class="text-slate-400"><i class="fas fa-chevron-left"></i></button>
                <span id="currentMonthDisplay" class="font-black text-[10px] uppercase w-32 text-center text-blue-400">Január</span>
                <button onclick="changeMonth(1)" class="text-slate-400"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="flex gap-2">
                <button onclick="setView('matrix')" id="btn-matrix" class="bg-blue-600 text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase">Mátrix</button>
                <button onclick="setView('stats')" id="btn-stats" class="bg-slate-700 text-white px-3 py-1.5 rounded text-[10px] font-bold uppercase">Adatlapok</button>
                <button onclick="addNewEmployee()" class="bg-emerald-600 px-3 py-1.5 rounded text-[10px] font-black uppercase text-white"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </header>

    <main class="p-2 no-print">
        <div id="view-matrix">
            <div class="table-container shadow-2xl" id="scrollContainer">
                <table class="matrix-table w-full border-collapse" id="mainMatrix">
                    <thead id="tableHeader" class="bg-slate-800 text-slate-400"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="view-stats" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 pt-4"></div>
    </main>

    <script>
        let currentShift = localStorage.getItem('forvia_current_shift') || 'A';
        const BASE_DB_URL = "https://forviastaff-default-rtdb.firebaseio.com/";
        let currentDate = new Date(2026, 0, 1);
        const monthNames = ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"];
        let employees = [];

        async function changeShift(newShift) {
            currentShift = newShift;
            localStorage.setItem('forvia_current_shift', newShift);
            document.querySelectorAll('.shift-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-shift-${newShift}`).classList.add('active');
            document.getElementById('shiftTitle').innerText = `MŰSZAK: ${newShift}`;
            await loadFromCloud();
        }

        async function save() {
            try {
                await fetch(`${BASE_DB_URL}shift_${currentShift}.json`, {
                    method: 'PUT',
                    body: JSON.stringify(employees)
                });
            } catch (e) { console.error("Mentési hiba"); }
        }

        async function loadFromCloud() {
            try {
                const response = await fetch(`${BASE_DB_URL}shift_${currentShift}.json`);
                const data = await response.json();
                employees = Array.isArray(data) ? data : [];
                render();
            } catch (e) { render(); }
        }

        // --- JAVÍTOTT LEVONÁSI LOGIKA ---
        function calculateUsedDays(emp) {
            let sum = 0;
            if (emp.data) {
                Object.values(emp.data).forEach(val => {
                    const num = parseFloat(val);
                    if (!isNaN(num)) sum += num;
                });
            }
            return sum;
        }

        function updateCell(id, key, val, inputElement) {
            const emp = employees.find(e => e.id === id);
            if(!emp) return;
            
            const v = val.trim().toUpperCase();
            if(v === "") delete emp.data[key]; else emp.data[key] = v;
            
            // UI frissítés azonnal
            inputElement.parentElement.className = inputElement.parentElement.className.replace(/cell-\S+/g, "").trim();
            const newClass = getCellClass(v);
            if(newClass) inputElement.parentElement.classList.add(newClass);
            
            const used = calculateUsedDays(emp);
            document.getElementById(`used-${id}`).innerText = used;
            document.getElementById(`rem-${id}`).innerText = (emp.yearlyQuota || 0) - used;
            
            save();
        }

        function getCellClass(v) {
            if (!v) return "";
            if (!isNaN(parseFloat(v))) return "cell-S";
            if (v === 'BÁ') return "cell-BA";
            if (v === 'IG') return "cell-IG";
            if (v === 'TU') return "cell-TU";
            if (v.startsWith('KÉ')) return "cell-KE";
            return "";
        }

        function render() {
            const year = 2026; const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            document.getElementById('currentMonthDisplay').innerText = monthNames[month];

            let header = `<tr><th class="name-col text-[9px] uppercase font-black">Munkatárs</th><th class="w-12 text-blue-400 text-[8px] uppercase">Keret</th><th class="w-12 text-orange-400 text-[8px] uppercase">Kivett</th><th class="w-12 text-emerald-400 text-[8px] uppercase">Maradt</th>`;
            for(let d=1; d<=daysInMonth; d++) header += `<th>${d}</th>`;
            document.getElementById('tableHeader').innerHTML = header + "</tr>";

            let body = "";
            employees.forEach(emp => {
                const used = calculateUsedDays(emp);
                const quota = emp.yearlyQuota || 0;
                body += `<tr>
                    <td class="name-col flex justify-between items-center">
                        <span class="font-bold text-[11px] truncate">${emp.name}</span>
                        <button onclick="removeEmp(${emp.id})" class="text-red-900/50 hover:text-red-500"><i class="fas fa-trash text-[10px]"></i></button>
                    </td>
                    <td><input type="number" value="${quota}" onchange="updateQuota(${emp.id}, this.value)" class="input-cell text-blue-400"></td>
                    <td id="used-${emp.id}" class="text-orange-400 font-bold">${used}</td>
                    <td id="rem-${emp.id}" class="text-emerald-500 font-black">${quota - used}</td>`;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const key = `${year}-${month+1}-${d}`;
                    const v = (emp.data && emp.data[key]) ? emp.data[key] : "";
                    body += `<td class="${getCellClass(v)}">
                        <input type="text" value="${v}" onblur="updateCell(${emp.id}, '${key}', this.value, this)" class="input-cell">
                    </td>`;
                }
                body += `</tr>`;
            });
            document.getElementById('tableBody').innerHTML = body;
        }

        function updateQuota(id, val) {
            const emp = employees.find(e => e.id === id);
            if(emp) {
                emp.yearlyQuota = parseInt(val) || 0;
                render();
                save();
            }
        }

        function setView(view) {
            document.getElementById('view-matrix').classList.toggle('hidden', view !== 'matrix');
            document.getElementById('view-stats').classList.toggle('hidden', view !== 'stats');
            if(view === 'stats') renderStats();
        }

        function renderStats() {
            document.getElementById('view-stats').innerHTML = employees.map(emp => {
                const used = calculateUsedDays(emp);
                return `<div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700">
                    <h3 class="text-sm font-black mb-2 text-white">${emp.name}</h3>
                    <div class="grid grid-cols-2 gap-2 text-center">
                        <div class="bg-slate-900 p-2 rounded-lg"><p class="text-[8px] text-slate-500 uppercase">Kivehető</p><p class="text-sm font-black text-emerald-500">${emp.yearlyQuota - used}</p></div>
                        <div class="bg-slate-900 p-2 rounded-lg"><p class="text-[8px] text-slate-500 uppercase">Kivett</p><p class="text-sm font-black text-orange-400">${used}</p></div>
                    </div>
                </div>`;
            }).join('');
        }

        function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); render(); }
        function addNewEmployee() { const n = prompt("Név:"); if(n) { employees.push({id:Date.now(), name:n, yearlyQuota:160, data:{}}); save(); render(); } }
        function removeEmp(id) { if(confirm("Törlés?")) { employees = employees.filter(e => e.id !== id); save(); render(); } }

        window.onload = () => changeShift(currentShift);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORVIA | Staff Pro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #e2e8f0; margin: 0; }
        
        /* EREDETI TÁBLÁZAT STÍLUS */
        .table-container { overflow-x: auto; border-radius: 8px; background: #111827; position: relative; scroll-behavior: smooth; }
        .name-col { position: sticky; left: 0; background: #1e293b; z-index: 40; min-width: 160px; border-right: 2px solid #3b82f6 !important; padding: 0 8px !important; }
        .matrix-table th, .matrix-table td { border: 1px solid #2d3748; min-width: 38px; height: 38px; text-align: center; font-size: 12px; position: relative; padding: 0; }
        
        .day-name { font-size: 7px; text-transform: uppercase; color: #64748b; font-weight: 800; display: block; line-height: 1; }
        .weekend { background: #141b2d !important; color: #64748b; }
        .holiday { background: #4c0505 !important; color: #fca5a5 !important; border: 1px solid #7f1d1d !important; }
        .today-cell { border: 2px solid #3b82f6 !important; background: rgba(59, 130, 246, 0.15) !important; }

        /* SZÍNEK KÉNYSZERÍTÉSE (!important) */
        .cell-S { background-color: #059669 !important; color: white !important; }
        .cell-BA { background-color: #ea580c !important; color: white !important; }
        .cell-IG { background-color: #7c3aed !important; color: white !important; }
        .cell-TU { background-color: #2563eb !important; color: white !important; }
        .cell-KE { background-color: #d97706 !important; color: white !important; }

        /* INPUT MEZŐK */
        .input-cell { width: 100%; height: 100%; border: none; text-align: center; background: transparent; color: white; font-weight: 800; outline: none; padding: 0; margin: 0; }
        
        /* JAVÍTÁS: Nincs transform scale, csak háttérszín változás fókuszkor */
        .matrix-table td:focus-within { background: rgba(59, 130, 246, 0.2); }

        /* GOMBOK ÉS FEJLÉC */
        .shift-btn { transition: all 0.2s; border: 1px solid #334155; }
        .shift-btn.active { color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .shift-A.active { background-color: #ef4444; border-color: #f87171; }
        .shift-B.active { background-color: #10b981; border-color: #34d399; }
        .shift-C.active { background-color: #f59e0b; border-color: #fbbf24; }
        .shift-D.active { background-color: #8b5cf6; border-color: #a78bfa; }
    </style>
</head>
<body class="pb-10">
    <header class="bg-[#111827] border-b border-slate-800 p-3 sticky top-0 z-50">
        <div class="max-w-full mx-auto flex flex-wrap justify-between items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="flex flex-col">
                    <span class="text-blue-500 font-black text-xl tracking-tighter leading-none">FORVIA</span>
                    <span id="shiftTitle" class="text-[10px] text-slate-400 uppercase font-bold italic">MŰSZAK: A</span>
                </div>
                <div class="flex bg-slate-900 p-1 rounded-lg gap-1 border border-slate-700">
                    <button onclick="changeShift('A')" id="btn-shift-A" class="shift-btn shift-A px-3 py-1 rounded text-[10px] font-black">A</button>
                    <button onclick="changeShift('B')" id="btn-shift-B" class="shift-btn shift-B px-3 py-1 rounded text-[10px] font-black">B</button>
                    <button onclick="changeShift('C')" id="btn-shift-C" class="shift-btn shift-C px-3 py-1 rounded text-[10px] font-black">C</button>
                    <button onclick="changeShift('D')" id="btn-shift-D" class="shift-btn shift-D px-3 py-1 rounded text-[10px] font-black">D</button>
                </div>
                <nav class="flex bg-slate-900 p-1 rounded-lg">
                    <button onclick="setView('matrix')" id="btn-matrix" class="px-3 py-1.5 rounded-md bg-blue-600 text-[10px] font-bold uppercase transition">Mátrix</button>
                    <button onclick="setView('stats')" id="btn-stats" class="px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition ml-1">Adatlapok</button>
                </nav>
            </div>

            <div class="flex items-center gap-4">
                <div id="sync-indicator" class="text-emerald-500 flex items-center gap-1 text-[10px] font-bold">
                    <i class="fas fa-cloud"></i> <span>Kész</span>
                </div>
                <div class="flex items-center gap-2 bg-slate-900/80 border border-slate-700 px-3 py-1 rounded-lg">
                    <button onclick="changeMonth(-1)" class="text-slate-400"><i class="fas fa-chevron-left text-xs"></i></button>
                    <span id="currentMonthDisplay" class="font-black text-[10px] uppercase tracking-tighter w-32 text-center text-blue-400">Január</span>
                    <button onclick="changeMonth(1)" class="text-slate-400"><i class="fas fa-chevron-right text-xs"></i></button>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="addNewEmployee()" class="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 rounded text-[10px] font-black uppercase flex items-center gap-2 text-white"><i class="fas fa-plus"></i> <span>Új</span></button>
            </div>
        </div>
    </header>

    <main class="p-2">
        <div id="view-matrix">
            <div class="table-container shadow-2xl">
                <table class="matrix-table w-full border-collapse" id="mainMatrix">
                    <thead id="tableHeader" class="bg-slate-800 text-slate-400"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="mt-4 flex flex-wrap gap-3 p-3 bg-slate-900/50 rounded-xl border border-slate-800">
                <div class="flex items-center gap-2 text-[10px] font-bold"><div class="w-3 h-3 bg-[#059669] rounded"></div> SZABADSÁG (óra)</div>
                <div class="flex items-center gap-2 text-[10px] font-bold"><div class="w-3 h-3 bg-[#ea580c] rounded"></div> BETEGÁLLOMÁNY (BÁ)</div>
                <div class="flex items-center gap-2 text-[10px] font-bold"><div class="w-3 h-3 bg-[#7c3aed] rounded"></div> IGAZOLATLAN (IG)</div>
                <div class="flex items-center gap-2 text-[10px] font-bold"><div class="w-3 h-3 bg-[#2563eb] rounded"></div> TÚLÓRA (TU)</div>
                <div class="flex items-center gap-2 text-[10px] font-bold"><div class="w-3 h-3 bg-[#d97706] rounded"></div> KÉSÉS (KÉ)</div>
            </div>
        </div>
        <div id="view-stats" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pt-4"></div>
    </main>

    <script>
        let currentShift = localStorage.getItem('forvia_current_shift') || 'A';
        const BASE_DB_URL = "https://forviastaff-default-rtdb.firebaseio.com/";
        let currentDate = new Date(2026, 0, 1);
        const dayNames = ['V', 'H', 'K', 'Sze', 'Cs', 'P', 'Szo'];
        const monthNames = ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"];
        const holidays2026 = ["2026-1-1", "2026-3-15", "2026-4-3", "2026-4-5", "2026-4-6", "2026-5-1", "2026-5-24", "2026-5-25", "2026-8-20", "2026-10-23", "2026-11-1", "2026-12-25", "2026-12-26"];
        let employees = [];

        // --- FELHŐ BETÖLTÉS ---
        async function changeShift(newShift) {
            currentShift = newShift;
            localStorage.setItem('forvia_current_shift', newShift);
            
            // Gombok frissítése
            document.querySelectorAll('.shift-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-shift-${newShift}`).classList.add('active');
            document.getElementById('shiftTitle').innerText = `MŰSZAK: ${newShift}`;
            
            await loadFromCloud();
        }

        async function loadFromCloud() {
            setSyncStatus('loading');
            try {
                const response = await fetch(`${BASE_DB_URL}shift_${currentShift}.json`);
                const data = await response.json();
                employees = (data && Array.isArray(data)) ? data : [];
                render();
                setSyncStatus('ok');
            } catch (e) {
                console.error(e);
                setSyncStatus('error');
            }
        }

        // --- FELHŐ MENTÉS ---
        async function save() {
            setSyncStatus('saving');
            try {
                await fetch(`${BASE_DB_URL}shift_${currentShift}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(employees)
                });
                setSyncStatus('ok');
            } catch (e) {
                console.error(e);
                setSyncStatus('error');
            }
        }

        function setSyncStatus(status) {
            const el = document.getElementById('sync-indicator');
            if (status === 'saving' || status === 'loading') el.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>Folyamatban...</span>';
            else if (status === 'error') el.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i> <span class="text-red-500">Hiba!</span>';
            else el.innerHTML = '<i class="fas fa-cloud text-emerald-500"></i> <span class="text-emerald-500">Naprakész</span>';
        }

        // --- CELLA LOGIKA ---
        function getCellClass(v) {
            if (!v) return "";
            const val = String(v).toUpperCase().trim();
            if (val === 'BÁ') return "cell-BA";
            if (val === 'IG') return "cell-IG";
            if (val === 'TU') return "cell-TU";
            if (val.startsWith('KÉ')) return "cell-KE";
            
            // Ha szám (8, 12, 8.5, 8,5)
            const num = parseFloat(val.replace(',', '.'));
            if (!isNaN(num)) return "cell-S";
            
            return "";
        }

        function updateCell(id, key, val, inputElement) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            
            const v = val.trim().toUpperCase();
            if (v === "") delete emp.data[key]; 
            else emp.data[key] = v;

            // AZONNALI SZÍNEZÉS
            const td = inputElement.parentElement;
            // Töröljük a régi színes osztályokat
            td.classList.remove('cell-S', 'cell-BA', 'cell-IG', 'cell-TU', 'cell-KE');
            
            const newClass = getCellClass(v);
            if (newClass) td.classList.add(newClass);

            updateRowTotals(id);
            save(); // Automatikus mentés minden beíráskor
        }

        function updateRowTotals(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            
            let sSum = 0;
            if (emp.data) {
                Object.values(emp.data).forEach(v => {
                    // Magyar vessző kezelése (pl. 8,5)
                    const num = parseFloat(String(v).replace(',', '.'));
                    if (!isNaN(num)) sSum += num;
                });
            }
            
            const remDisplay = document.getElementById(`rem-${id}`);
            if (remDisplay) remDisplay.innerText = (emp.yearlyQuota || 0) - sSum;
        }

        // --- MEGJELENÍTÉS (RENDER) ---
        function render() {
            const year = 2026; 
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const realToday = new Date();
            
            document.getElementById('currentMonthDisplay').innerText = monthNames[month];

            // Fejléc generálás
            let header = `<tr>
                <th class="name-col text-[9px] uppercase font-black">Munkatárs</th>
                <th class="w-12 text-blue-400 text-[8px] uppercase font-black">Keret</th>
                <th class="w-12 text-emerald-400 text-[8px] uppercase font-black">Kiv.</th>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dayOfWeek = dateObj.getDay();
                const isW = [0, 6].includes(dayOfWeek);
                const isToday = realToday.getFullYear() === year && realToday.getMonth() === month && realToday.getDate() === d;
                
                header += `<th class="${isW ? 'weekend' : ''} ${holidays2026.includes(`${year}-${month+1}-${d}`) ? 'holiday' : ''} ${isToday ? 'today-cell' : ''}">
                    ${d}<span class="day-name">${dayNames[dayOfWeek]}</span>
                </th>`;
            }
            document.getElementById('tableHeader').innerHTML = header + "</tr>";

            // Test generálás
            let body = "";
            employees.forEach(emp => {
                // Kiszámoljuk a "Kivett" értéket betöltéskor
                let sSum = 0; 
                if(emp.data) {
                    Object.values(emp.data).forEach(v => { 
                        const num = parseFloat(String(v).replace(',', '.')); 
                        if(!isNaN(num)) sSum += num; 
                    });
                }
                
                body += `<tr>
                    <td class="name-col flex justify-between items-center px-2">
                        <span class="font-bold text-[11px] truncate text-white">${emp.name}</span>
                        <button onclick="removeEmp(${emp.id})" class="text-red-900/30 hover:text-red-500 ml-1"><i class="fas fa-trash text-[10px]"></i></button>
                    </td>
                    <td>
                        <input type="number" value="${emp.yearlyQuota || 160}" 
                        oninput="const e=employees.find(x=>x.id===${emp.id}); e.yearlyQuota=parseInt(this.value)||0; updateRowTotals(${emp.id}); save();" 
                        class="input-cell text-blue-400">
                    </td>
                    <td id="rem-${emp.id}" class="text-emerald-500 font-black text-[11px] bg-slate-900/50">
                        ${(emp.yearlyQuota || 0) - sSum}
                    </td>`;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const key = `${year}-${month+1}-${d}`;
                    const v = (emp.data && emp.data[key]) ? emp.data[key] : "";
                    const cellClass = getCellClass(v); // Itt határozzuk meg a színt betöltéskor
                    
                    body += `<td class="${cellClass}">
                        <input type="text" value="${v}" 
                        onblur="updateCell(${emp.id}, '${key}', this.value, this)" 
                        class="input-cell">
                    </td>`;
                }
                body += `</tr>`;
            });
            document.getElementById('tableBody').innerHTML = body;
        }

        // --- NÉZETVÁLTÓ ÉS STATISZTIKA ---
        function setView(view) {
            document.getElementById('view-matrix').classList.toggle('hidden', view !== 'matrix');
            document.getElementById('view-stats').classList.toggle('hidden', view !== 'stats');
            document.getElementById('btn-matrix').classList.toggle('bg-blue-600', view === 'matrix');
            document.getElementById('btn-stats').classList.toggle('bg-blue-600', view === 'stats');
            if(view === 'stats') renderStats();
        }

        function renderStats() {
            document.getElementById('view-stats').innerHTML = employees.map(emp => {
                let s = { S:0, BA:0, IG:0, TU:0, KE:0 };
                if(emp.data) Object.values(emp.data).forEach(v => { 
                    const val = String(v).toUpperCase().trim();
                    const n = parseFloat(val.replace(',', '.'));
                    
                    if(!isNaN(n)) s.S += n; 
                    else if(val === 'BÁ') s.BA++; 
                    else if(val === 'IG') s.IG++; 
                    else if(val === 'TU') s.TU++; 
                    else if(val.startsWith('KÉ')) s.KE++;
                });
                
                return `<div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-black text-lg text-white">${emp.name}</h3>
                        <span class="text-xs font-mono text-slate-500">ID: ${emp.id.toString().slice(-4)}</span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs border-b border-slate-700 pb-1"><span>Szabadság (óra):</span><span class="text-emerald-400 font-bold">${s.S}</span></div>
                        <div class="flex justify-between text-xs border-b border-slate-700 pb-1"><span>Betegállomány:</span><span class="text-orange-500 font-bold">${s.BA} nap</span></div>
                        <div class="flex justify-between text-xs border-b border-slate-700 pb-1"><span>Igazolatlan:</span><span class="text-purple-500 font-bold">${s.IG} nap</span></div>
                        <div class="flex justify-between text-xs"><span>Túlóra:</span><span class="text-blue-500 font-bold">${s.TU} nap</span></div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- EGYÉB FÜGGVÉNYEK ---
        function addNewEmployee() { 
            const n = prompt("Dolgozó neve:"); 
            if(n) { 
                employees.push({id:Date.now(), name:n, yearlyQuota:160, data:{}}); 
                save(); 
                render(); 
            } 
        }
        
        function removeEmp(id) { 
            if(confirm("Biztosan törlöd ezt a dolgozót?")) { 
                employees = employees.filter(e => e.id !== id); 
                save(); 
                render(); 
            } 
        }
        
        function changeMonth(d) { 
            currentDate.setMonth(currentDate.getMonth() + d); 
            render(); 
        }

        // Indítás
        window.onload = () => changeShift(currentShift);
    </script>
</body>
</html>

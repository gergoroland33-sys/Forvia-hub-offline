<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORVIA | Staff Pro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #e2e8f0; margin: 0; overflow: hidden; /* A body ne görgessen, csak a táblázat */ }
        
        header { background: linear-gradient(to bottom, #111827, #0f172a); border-bottom: 1px solid #1e293b; height: auto; min-height: 120px; }
        
        /* --- TÁBLÁZAT KEZELÉS --- */
        .table-container { 
            /* MOBIL FIX: A képernyő maradék részét töltse ki, így görgethető marad */
            height: calc(100vh - 190px); 
            width: 100%;
            overflow: auto; /* Görgetés engedélyezése minden irányba */
            background: #111827; 
            border-top: 1px solid #1e293b;
            -webkit-overflow-scrolling: touch; /* Sima görgetés iOS-en */
        }

        .matrix-table { border-collapse: separate; border-spacing: 0; }
        
        /* Fejléc rögzítése */
        .matrix-table thead th {
            position: sticky;
            top: 0;
            z-index: 30;
            background: #1e293b;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            height: 40px;
        }

        /* Név oszlop rögzítése bal oldalon */
        .name-col { 
            position: sticky; 
            left: 0; 
            background: #1e293b; 
            z-index: 40; 
            min-width: 140px; 
            max-width: 140px; /* Mobilon ne legyen túl széles */
            border-right: 3px solid #3b82f6 !important; 
            cursor: grab;
            padding: 0 5px !important;
        }

        /* Bal felső sarok mindig felül */
        .matrix-table thead th.name-col { z-index: 50 !important; background: #1e293b; }

        .data-col-fix {
            min-width: 60px !important;
            max-width: 60px !important;
            width: 60px !important;
        }

        .matrix-table th, .matrix-table td { 
            border: 1px solid #2d3748; 
            min-width: 42px; 
            height: 45px; 
            text-align: center; 
            font-size: 13px; 
        }

        .matrix-table th { color: #94a3b8; font-weight: 700; text-transform: uppercase; font-size: 11px; }

        .row-highlight { background: rgba(59, 130, 246, 0.25) !important; }
        .col-highlight { background: rgba(59, 130, 246, 0.25) !important; }

        .cell-S { background: #059669 !important; color: white !important; font-weight: 900; }
        .cell-BA { background: #ea580c !important; color: white !important; font-weight: 900; }
        .cell-IG { background: #7c3aed !important; color: white !important; font-weight: 900; }
        .cell-TU { background: #2563eb !important; color: white !important; font-weight: 900; }
        .cell-KE { background: #d97706 !important; color: white !important; font-weight: 900; }
        
        .input-cell { 
            width: 100%; height: 100%; border: none; text-align: center; background: transparent; 
            color: white; font-weight: 800; outline: none; font-size: 16px; 
        }

        .quota-input { font-size: 15px !important; font-weight: 900 !important; color: #93c5fd !important; }

        /* Hétvége és ünnepnap stílus */
        .weekend { background: #141b2d !important; color: #64748b; }
        .holiday-header { color: #ef4444 !important; font-weight: 900 !important; } /* Piros dátum a fejlécben */

        .shift-btn { transition: all 0.3s; border: 1px solid #334155; }
        .shift-btn.active { transform: scale(1.05); color: white; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
        .shift-A.active { background: #ef4444; border-color: #f87171; }
        .shift-B.active { background: #10b981; border-color: #34d399; }
        .shift-C.active { background: #f59e0b; border-color: #fbbf24; }
        .shift-D.active { background: #8b5cf6; border-color: #a78bfa; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; overflow: visible !important; }
            #print-area { display: block !important; }
            table { border-collapse: collapse; border: 2px solid black; }
            th, td { border: 1px solid black !important; color: black !important; }
            .table-container { height: auto !important; overflow: visible !important; }
        }
    </style>
</head>
<body class="pb-0">
    <div id="print-area" class="hidden"></div>

    <header class="p-2 sticky top-0 z-[60] no-print shadow-xl flex flex-col gap-2 justify-center">
        <div class="flex justify-between items-center w-full">
            <div class="flex flex-col">
                <span class="text-blue-500 font-black text-xl tracking-tighter leading-none">FORVIA</span>
                <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Staff Pro 2026</span>
            </div>
            <div class="flex bg-slate-900/80 p-1 rounded-lg gap-1 border border-slate-700/50">
                <button onclick="changeShift('A')" id="btn-shift-A" class="shift-btn shift-A px-3 py-1.5 rounded text-[10px] font-black uppercase">A</button>
                <button onclick="changeShift('B')" id="btn-shift-B" class="shift-btn shift-B px-3 py-1.5 rounded text-[10px] font-black uppercase">B</button>
                <button onclick="changeShift('C')" id="btn-shift-C" class="shift-btn shift-C px-3 py-1.5 rounded text-[10px] font-black uppercase">C</button>
                <button onclick="changeShift('D')" id="btn-shift-D" class="shift-btn shift-D px-3 py-1.5 rounded text-[10px] font-black uppercase">D</button>
            </div>
        </div>

        <div class="flex items-center justify-between w-full gap-2 overflow-x-auto pb-1">
            <div id="sync" class="bg-emerald-500/10 text-emerald-500 px-2 py-1 rounded-full text-[9px] font-black border border-emerald-500/20 whitespace-nowrap">
                ONLINE
            </div>
            
            <div class="flex items-center bg-slate-900/80 border border-slate-700/50 rounded-lg p-0.5">
                <button onclick="changeMonth(-1)" class="p-2 text-blue-400 hover:text-white"><i class="fas fa-chevron-left text-xs"></i></button>
                <span id="monthDisp" class="font-black text-xs uppercase w-20 text-center text-blue-400 tracking-widest">Jan</span>
                <button onclick="changeMonth(1)" class="p-2 text-blue-400 hover:text-white"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>

            <div class="flex bg-slate-900/80 p-0.5 rounded-lg border border-slate-700/50">
                <button onclick="setView('matrix')" id="nav-m" class="px-3 py-1.5 rounded text-[10px] font-black uppercase"><i class="fas fa-table"></i></button>
                <button onclick="setView('stats')" id="nav-s" class="px-3 py-1.5 rounded text-[10px] font-black uppercase ml-1"><i class="fas fa-id-card"></i></button>
            </div>
            
            <button onclick="addEmp()" class="bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase text-white shadow-lg shadow-blue-600/20 whitespace-nowrap">
                 <i class="fas fa-plus"></i>
            </button>
        </div>
    </header>

    <main class="no-print w-full h-full relative">
        <div id="v-matrix" class="w-full h-full">
            <div class="table-container shadow-2xl">
                <table class="matrix-table" id="mainTable">
                    <thead id="tHead"></thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="v-stats" class="hidden p-4 overflow-y-auto" style="height: calc(100vh - 130px);">
            <div id="stats-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-10"></div>
        </div>
    </main>

    <script>
        let currentShift = localStorage.getItem('fv_shift_final') || 'A';
        const DB = "https://forviastaff-default-rtdb.firebaseio.com/";
        let date = new Date(2026, 0, 1);
        let employees = [];
        const monthNames = ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"];
        
        // Ünnepnapok 2026 (Hónap-Nap formátum, a hónap 1-től indul itt)
        const holidays2026 = [
            "1-1",   // Újév
            "3-15",  // Nemzeti ünnep
            "4-3",   // Nagypéntek
            "4-6",   // Húsvéthétfő
            "5-1",   // Munka ünnepe
            "5-25",  // Pünkösdhétfő
            "8-20",  // Államalapítás
            "10-23", // '56-os forradalom
            "11-1",  // Mindenszentek
            "12-25", // Karácsony
            "12-26"  // Karácsony
        ];

        async function changeShift(s) {
            currentShift = s;
            localStorage.setItem('fv_shift_final', s);
            document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-shift-${s}`).classList.add('active');
            await load();
        }

        async function load() {
            try {
                const res = await fetch(`${DB}shift_${currentShift}.json`);
                const data = await res.json();
                employees = Array.isArray(data) ? data : [];
                render();
                initSortable();
            } catch(e) { console.error("Load hiba"); }
        }

        async function save() {
            document.getElementById('sync').innerHTML = '<i class="fas fa-spin fa-sync"></i>';
            try {
                await fetch(`${DB}shift_${currentShift}.json`, { method: 'PUT', body: JSON.stringify(employees) });
                document.getElementById('sync').innerHTML = 'ONLINE';
            } catch(e) { document.getElementById('sync').innerText = "HIBA!"; }
        }

        function initSortable() {
            Sortable.create(document.getElementById('tBody'), {
                animation: 150,
                handle: '.name-col',
                onEnd: function() {
                    let newOrder = [];
                    document.querySelectorAll('#tBody tr').forEach(tr => {
                        newOrder.push(employees.find(e => e.id == tr.dataset.id));
                    });
                    employees = newOrder;
                    save();
                }
            });
        }

        function highlight(el, dIdx, active) {
            const tr = el.closest('tr');
            tr.classList.toggle('row-highlight', active);
            const rows = document.getElementById('mainTable').rows;
            for(let r of rows) if(r.cells[dIdx+2]) r.cells[dIdx+2].classList.toggle('col-highlight', active);
        }

        function update(id, key, val, el) {
            const emp = employees.find(e => e.id == id);
            const v = val.trim().toUpperCase();
            emp.data = emp.data || {};
            if(v === "") delete emp.data[key]; else emp.data[key] = v;
            
            const td = el.parentElement;
            td.className = td.className.replace(/cell-\S+/g, "").trim();
            const cls = (v && !isNaN(parseFloat(v.replace(',','.')))) ? 'cell-S' : 
                        (v==='BÁ'?'cell-BA':v==='IG'?'cell-IG':v==='TU'?'cell-TU':v.startsWith('KÉ')?'cell-KE':'');
            if(cls) td.classList.add(cls);
            
            let s = 0; Object.values(emp.data).forEach(x => { let n=parseFloat(String(x).replace(',','.')); if(!isNaN(n)) s+=n; });
            document.getElementById(`rem-${id}`).innerText = (emp.yearlyQuota || 160) - s;
            save();
        }

        function render() {
            const m = date.getMonth();
            const days = new Date(2026, m+1, 0).getDate();
            document.getElementById('monthDisp').innerText = monthNames[m];

            let h = `<tr>
                <th class="name-col">Név</th>
                <th class="data-col-fix bg-slate-800 text-blue-300 border-b border-slate-700">KERET</th>
                <th class="data-col-fix bg-slate-800 text-emerald-400 border-b border-slate-700 border-r-4 border-r-slate-900">KIV</th>`;
            
            for(let d=1; d<=days; d++) {
                // Ünnepnap ellenőrzés
                const isHoliday = holidays2026.includes(`${m+1}-${d}`);
                // Ha ünnepnap, kapjon piros színt a fejlécben
                const headerClass = isHoliday ? 'holiday-header' : '';
                h += `<th class="${headerClass}">${d}</th>`;
            }
            document.getElementById('tHead').innerHTML = h + "</tr>";

            document.getElementById('tBody').innerHTML = employees.map(e => {
                let s = 0; if(e.data) Object.values(e.data).forEach(v => { let n=parseFloat(String(v).replace(',','.')); if(!isNaN(n)) s+=n; });
                
                let row = `<tr data-id="${e.id}"><td class="name-col flex justify-between items-center">
                    <span class="font-black text-[12px] tracking-tight truncate uppercase text-white">${e.name}</span>
                    <button onclick="delEmp(${e.id})" class="text-red-500/30 hover:text-red-500 transition-colors p-1"><i class="fas fa-times-circle"></i></button>
                </td>
                <td class="data-col-fix bg-slate-800 border-r border-slate-700/50">
                    <input type="number" value="${e.yearlyQuota||160}" onchange="employees.find(x=>x.id==${e.id}).yearlyQuota=this.value; save(); render();" class="input-cell quota-input text-center">
                </td>
                <td id="rem-${e.id}" class="data-col-fix bg-slate-800 text-emerald-400 font-black text-[15px] border-r-4 border-slate-900 text-center">
                    ${(e.yearlyQuota||160)-s}
                </td>`;
                
                for(let d=1; d<=days; d++) {
                    const k = `2026-${m+1}-${d}`, v = (e.data && e.data[k]) ? e.data[k] : "";
                    const dayObj = new Date(2026,m,d);
                    const isWeekend = [0,6].includes(dayObj.getDay());
                    const isHoliday = holidays2026.includes(`${m+1}-${d}`);
                    
                    // Ha hétvége VAGY ünnepnap, akkor sötét háttér (.weekend)
                    const isOffDay = isWeekend || isHoliday;
                    
                    const cls = (v && !isNaN(parseFloat(v.replace(',','.')))) ? 'cell-S' : (v==='BÁ'?'cell-BA':v==='IG'?'cell-IG':v==='TU'?'cell-TU':v.startsWith('KÉ')?'cell-KE':'');
                    row += `<td class="${isOffDay?'weekend':''} ${cls}"><input type="text" value="${v}" onfocus="this.select(); highlight(this,${d},true)" onblur="highlight(this,${d},false); update(${e.id},'${k}',this.value,this)" class="input-cell"></td>`;
                }
                return row + "</tr>";
            }).join('');
        }

        function printA4(id) {
            const emp = employees.find(x => x.id == id);
            let s = { S:0, BA:0, IG:0, TU:0, KE:0 };
            const mData = Array(12).fill(0).map(() => ({S:0, BA:0, IG:0, TU:0, KE:0}));
            if(emp.data) Object.entries(emp.data).forEach(([key, v]) => {
                const m = parseInt(key.split('-')[1]) - 1;
                const n = parseFloat(String(v).replace(',','.'));
                if(!isNaN(n)) { s.S += n; mData[m].S += n; }
                else if(v==='BÁ') { s.BA++; mData[m].BA++; }
                else if(v==='IG') { s.IG++; mData[m].IG++; }
                else if(v==='TU') { s.TU++; mData[m].TU++; }
                else if(String(v).startsWith('KÉ')) { s.KE++; mData[m].KE++; }
            });

            let rows = mData.map((m, i) => `<tr><td>${monthNames[i]}</td><td>${m.S}</td><td>${m.BA}</td><td>${m.IG}</td><td>${m.TU}</td><td>${m.KE}</td></tr>`).join('');

            document.getElementById('print-area').innerHTML = `
                <div style="color:black; background:white; font-family:sans-serif; padding:40px;">
                    <h1 style="margin:0; color:#3b82f6;">FORVIA - 2026</h1>
                    <h2 style="border-bottom:2px solid #3b82f6; padding-bottom:10px;">ADATLAP: ${emp.name}</h2>
                    <div style="display:flex; justify-between; margin:20px 0; font-size:18px;">
                        <p>Éves keret: <b>${emp.yearlyQuota || 160} óra</b></p>
                        <p style="margin-left:40px">Kivett: <b>${s.S} óra</b></p>
                        <p style="margin-left:40px">Maradék: <b style="color:green">${(emp.yearlyQuota || 160) - s.S} óra</b></p>
                    </div>
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <thead><tr style="background:#f1f5f9;"><th>HÓNAP</th><th>SZABADSÁG</th><th>BÁ</th><th>IG</th><th>TU</th><th>KÉ</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
            window.print();
        }

        function setView(v) {
            document.getElementById('v-matrix').classList.toggle('hidden', v !== 'matrix');
            document.getElementById('v-stats').classList.toggle('hidden', v !== 'stats');
            
            document.getElementById('nav-m').className = v === 'matrix' ? "px-3 py-1.5 rounded text-[10px] font-black uppercase bg-blue-600 text-white" : "px-3 py-1.5 rounded text-[10px] font-black uppercase text-slate-400 hover:text-white";
            document.getElementById('nav-s').className = v === 'stats' ? "px-3 py-1.5 rounded text-[10px] font-black uppercase bg-blue-600 text-white" : "px-3 py-1.5 rounded text-[10px] font-black uppercase text-slate-400 hover:text-white";
            
            if(v==='stats') {
                document.getElementById('stats-grid').innerHTML = employees.map(e => {
                    let totals = { S:0, BA:0, IG:0, TU:0, KE:0 };
                    if(e.data) Object.values(e.data).forEach(val => {
                        let n = parseFloat(String(val).replace(',','.'));
                        if(!isNaN(n)) totals.S += n;
                        else if(val==='BÁ') totals.BA++;
                        else if(val==='IG') totals.IG++;
                        else if(val==='TU') totals.TU++;
                        else if(String(val).startsWith('KÉ')) totals.KE++;
                    });
                    
                    const rem = (e.yearlyQuota||160) - totals.S;
                    const percent = Math.max(0, Math.min(100, (totals.S / (e.yearlyQuota||160)) * 100));

                    return `<div class="bg-slate-900/80 rounded-2xl border border-slate-800 shadow-xl overflow-hidden flex flex-col">
                        <div class="p-6 pb-4 border-b border-slate-800">
                            <h3 class="font-black text-xl text-white uppercase tracking-tighter mb-2">${e.name}</h3>
                            <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden mb-2">
                                <div class="h-full bg-gradient-to-r from-blue-500 to-emerald-400" style="width: ${percent}%"></div>
                            </div>
                            <div class="flex justify-between items-end">
                                <div class="text-[10px] text-slate-400 font-bold uppercase">Keret: ${e.yearlyQuota||160}</div>
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-500 font-bold uppercase">Még kivehető</div>
                                    <div class="text-2xl font-black text-emerald-400 leading-none">${rem} <span class="text-sm font-normal text-slate-500">óra</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 grid grid-cols-2 gap-2 bg-slate-900/50 flex-grow content-start">
                            <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 flex justify-between items-center">
                                <span class="text-[10px] text-slate-400 font-bold">SZABI</span>
                                <span class="font-bold text-white">${totals.S}</span>
                            </div>
                            <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 flex justify-between items-center">
                                <span class="text-[10px] text-orange-400 font-bold">BETEG</span>
                                <span class="font-bold text-orange-400">${totals.BA}</span>
                            </div>
                            <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 flex justify-between items-center">
                                <span class="text-[10px] text-violet-400 font-bold">IGAZOLT</span>
                                <span class="font-bold text-violet-400">${totals.IG}</span>
                            </div>
                            <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 flex justify-between items-center">
                                <span class="text-[10px] text-blue-400 font-bold">SULI</span>
                                <span class="font-bold text-blue-400">${totals.TU}</span>
                            </div>
                             <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 flex justify-between items-center col-span-2">
                                <span class="text-[10px] text-amber-500 font-bold">KÉPZÉS</span>
                                <span class="font-bold text-amber-500">${totals.KE}</span>
                            </div>
                        </div>

                        <div class="p-4 pt-2">
                             <button onclick="printA4(${e.id})" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-black text-[10px] uppercase transition-all tracking-widest text-white shadow-lg shadow-blue-900/20">
                                <i class="fas fa-print mr-2"></i> Részletes adatlap
                             </button>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function changeMonth(v) { date.setMonth(date.getMonth() + v); render(); }
        function addEmp() { const n = prompt("Munkatárs neve:"); if(n) { employees.push({id:Date.now(), name:n, yearlyQuota:160, data:{}}); save(); render(); } }
        function delEmp(id) { if(confirm("Biztosan törlöd?")) { employees = employees.filter(x => x.id != id); save(); render(); } }

        window.onload = () => changeShift(currentShift);
    </script>
</body>
</html>

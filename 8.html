<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FORVIA | Staff Pro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0f1a; color: #e2e8f0; margin: 0; touch-action: manipulation; }
        .table-container { overflow-x: auto; border-radius: 8px; background: #111827; }
        .matrix-table { border-collapse: separate; border-spacing: 0; }
        .name-col { position: sticky; left: 0; background: #1e293b; z-index: 40; min-width: 170px; border-right: 2px solid #3b82f6 !important; cursor: grab; }
        .matrix-table th, .matrix-table td { border: 1px solid #2d3748; min-width: 40px; height: 40px; text-align: center; font-size: 12px; }
        
        .row-highlight { background: rgba(59, 130, 246, 0.2) !important; }
        .col-highlight { background: rgba(59, 130, 246, 0.2) !important; }
        
        .cell-S { background: #059669 !important; color: white !important; }
        .cell-BA { background: #ea580c !important; color: white !important; }
        .cell-IG { background: #7c3aed !important; color: white !important; }
        .cell-TU { background: #2563eb !important; color: white !important; }
        .cell-KE { background: #d97706 !important; color: white !important; }
        
        .input-cell { width: 100%; height: 100%; border: none; text-align: center; background: transparent; color: white; font-weight: 800; outline: none; font-size: 16px; }
        .weekend { background: #141b2d !important; color: #64748b; }
        
        .shift-btn { border: 1px solid #334155; }
        .shift-btn.active { box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); color: white; }
        .shift-A.active { background: #ef4444; }
        .shift-B.active { background: #10b981; }
        .shift-C.active { background: #f59e0b; }
        .shift-D.active { background: #8b5cf6; }

        /* Sortable ghost effect */
        .sortable-ghost { opacity: 0.4; background: #3b82f6 !important; }
    </style>
</head>
<body class="pb-20">
    <header class="bg-[#111827] border-b border-slate-800 p-3 sticky top-0 z-50">
        <div class="flex justify-between items-center gap-2">
            <div class="flex items-center gap-3">
                <span class="text-blue-500 font-black text-xl tracking-tighter">FORVIA</span>
                <div class="flex bg-slate-900 p-1 rounded-lg border border-slate-700">
                    <button onclick="changeShift('A')" id="btn-shift-A" class="shift-btn shift-A px-3 py-1 rounded text-[10px] font-black">A</button>
                    <button onclick="changeShift('B')" id="btn-shift-B" class="shift-btn shift-B px-3 py-1 rounded text-[10px] font-black">B</button>
                    <button onclick="changeShift('C')" id="btn-shift-C" class="shift-btn shift-C px-3 py-1 rounded text-[10px] font-black">C</button>
                    <button onclick="changeShift('D')" id="btn-shift-D" class="shift-btn shift-D px-3 py-1 rounded text-[10px] font-black">D</button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="sync" class="text-emerald-500 text-[10px] font-bold"><i class="fas fa-cloud"></i> OK</span>
                <button onclick="changeMonth(-1)" class="p-1"><i class="fas fa-chevron-left text-xs"></i></button>
                <span id="monthDisp" class="font-black text-[10px] uppercase w-20 text-center text-blue-400">Jan</span>
                <button onclick="changeMonth(1)" class="p-1"><i class="fas fa-chevron-right text-xs"></i></button>
                <button onclick="setView('matrix')" id="nav-m" class="bg-blue-600 px-2 py-1.5 rounded text-[10px] font-bold">MÁTRIX</button>
                <button onclick="setView('stats')" id="nav-s" class="bg-slate-800 px-2 py-1.5 rounded text-[10px] font-bold">ADATLAP</button>
                <button onclick="addEmp()" class="bg-emerald-600 px-2 py-1.5 rounded text-[10px] font-bold text-white">+ ÚJ</button>
            </div>
        </div>
    </header>

    <main class="p-2">
        <div id="v-matrix">
            <div class="table-container shadow-2xl">
                <table class="matrix-table w-full" id="mainTable">
                    <thead id="tHead" class="bg-slate-800 text-slate-400"></thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>

            <div class="mt-6 flex flex-wrap gap-4 p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                <div class="flex items-center gap-2 text-xs font-bold"><div class="w-4 h-4 rounded cell-S"></div> Szabadság (8, 4)</div>
                <div class="flex items-center gap-2 text-xs font-bold"><div class="w-4 h-4 rounded cell-BA"></div> Betegállomány (BÁ)</div>
                <div class="flex items-center gap-2 text-xs font-bold"><div class="w-4 h-4 rounded cell-IG"></div> Igazolt hiány (IG)</div>
                <div class="flex items-center gap-2 text-xs font-bold"><div class="w-4 h-4 rounded cell-TU"></div> Tanulmányi (TU)</div>
                <div class="flex items-center gap-2 text-xs font-bold"><div class="w-4 h-4 rounded cell-KE"></div> Képzés (KÉ)</div>
            </div>
        </div>
        <div id="v-stats" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4"></div>
    </main>

    <script>
        let currentShift = localStorage.getItem('fv_shift') || 'A';
        const DB = "https://forviastaff-default-rtdb.firebaseio.com/";
        let date = new Date(2026, 0, 1);
        let employees = [];

        async function changeShift(s) {
            currentShift = s;
            localStorage.setItem('fv_shift', s);
            document.querySelectorAll('.shift-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-shift-${s}`).classList.add('active');
            await load();
        }

        async function load() {
            try {
                const res = await fetch(`${DB}shift_${currentShift}.json`);
                const data = await res.json();
                employees = Array.isArray(data) ? data : [];
                render();
                initSortable();
            } catch(e) { console.error("Hiba"); }
        }

        async function save() {
            document.getElementById('sync').innerHTML = '<i class="fas fa-sync fa-spin"></i>';
            try {
                await fetch(`${DB}shift_${currentShift}.json`, { method: 'PUT', body: JSON.stringify(employees) });
                document.getElementById('sync').innerHTML = '<i class="fas fa-cloud"></i> OK';
            } catch(e) { document.getElementById('sync').innerText = "HIBA"; }
        }

        function initSortable() {
            const el = document.getElementById('tBody');
            Sortable.create(el, {
                animation: 150,
                handle: '.name-col',
                onEnd: function() {
                    const newOrder = [];
                    document.querySelectorAll('#tBody tr').forEach(tr => {
                        const id = parseInt(tr.getAttribute('data-id'));
                        newOrder.push(employees.find(e => e.id === id));
                    });
                    employees = newOrder;
                    save();
                }
            });
        }

        function highlight(el, dIdx, active) {
            const tr = el.closest('tr');
            tr.classList.toggle('row-highlight', active);
            const rows = document.getElementById('mainTable').rows;
            for(let r of rows) if(r.cells[dIdx+2]) r.cells[dIdx+2].classList.toggle('col-highlight', active);
        }

        function update(id, key, val, el) {
            const emp = employees.find(e => e.id === id);
            if(!emp) return;
            const v = val.trim().toUpperCase();
            emp.data = emp.data || {};
            if(v === "") delete emp.data[key]; else emp.data[key] = v;
            
            el.parentElement.className = el.parentElement.className.replace(/cell-\S+/g, "").trim();
            const cls = (v && !isNaN(parseFloat(v.replace(',','.')))) ? 'cell-S' : 
                        (v === 'BÁ' ? 'cell-BA' : v === 'IG' ? 'cell-IG' : v === 'TU' ? 'cell-TU' : v.startsWith('KÉ') ? 'cell-KE' : '');
            if(cls) el.parentElement.classList.add(cls);
            
            let taken = 0;
            Object.values(emp.data).forEach(x => { const n = parseFloat(String(x).replace(',','.')); if(!isNaN(n)) taken += n; });
            document.getElementById(`rem-${id}`).innerText = (emp.yearlyQuota || 160) - taken;
            save();
        }

        function render() {
            const m = date.getMonth();
            const days = new Date(2026, m+1, 0).getDate();
            const mNames = ["Január","Február","Március","Április","Május","Június","Július","Augusztus","Szeptember","Október","November","December"];
            document.getElementById('monthDisp').innerText = mNames[m].substring(0,3);

            let h = `<tr><th class="name-col">MUNKATÁRS</th><th>KERT</th><th>KIV</th>`;
            for(let d=1; d<=days; d++) h += `<th>${d}</th>`;
            document.getElementById('tHead').innerHTML = h + "</tr>";

            document.getElementById('tBody').innerHTML = employees.map(e => {
                let taken = 0; if(e.data) Object.values(e.data).forEach(v => { const n = parseFloat(String(v).replace(',','.')); if(!isNaN(n)) taken += n; });
                let row = `<tr data-id="${e.id}"><td class="name-col flex justify-between items-center px-2">
                    <span class="font-bold text-[11px] truncate">${e.name}</span>
                    <button onclick="delEmp(${e.id})" class="text-red-500/50 hover:text-red-500 font-black px-1">×</button>
                </td>
                <td><input type="number" value="${e.yearlyQuota||160}" onchange="e.yearlyQuota=this.value; save(); render();" class="input-cell text-blue-400"></td>
                <td id="rem-${e.id}" class="text-emerald-500 font-bold">${(e.yearlyQuota||160)-taken}</td>`;
                for(let d=1; d<=days; d++) {
                    const k = `2026-${m+1}-${d}`, v = (e.data && e.data[k]) ? e.data[k] : "";
                    const isW = [0,6].includes(new Date(2026,m,d).getDay());
                    const cls = (v && !isNaN(parseFloat(v.replace(',','.')))) ? 'cell-S' : (v==='BÁ'?'cell-BA':v==='IG'?'cell-IG':v==='TU'?'cell-TU':v.startsWith('KÉ')?'cell-KE':'');
                    row += `<td class="${isW?'weekend':''} ${cls}"><input type="text" value="${v}" onfocus="this.select(); highlight(this,${d},true)" onblur="highlight(this,${d},false); update(${e.id},'${k}',this.value,this)" class="input-cell"></td>`;
                }
                return row + "</tr>";
            }).join('');
        }

        function setView(v) {
            document.getElementById('v-matrix').classList.toggle('hidden', v !== 'matrix');
            document.getElementById('v-stats').classList.toggle('hidden', v !== 'stats');
            document.getElementById('nav-m').classList.toggle('bg-blue-600', v === 'matrix');
            document.getElementById('nav-s').classList.toggle('bg-blue-600', v === 'stats');
            if(v==='stats') {
                document.getElementById('v-stats').innerHTML = employees.map(e => {
                    let s = 0; if(e.data) Object.values(e.data).forEach(v => { const n = parseFloat(String(v).replace(',','.')); if(!isNaN(n)) s += n; });
                    return `<div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                        <h3 class="font-black">${e.name}</h3>
                        <p class="text-xs text-slate-400">Maradék: <span class="text-emerald-500 font-bold">${(e.yearlyQuota||160)-s} óra</span></p>
                        <button onclick="window.print()" class="w-full bg-blue-600 mt-2 py-2 rounded-lg font-bold text-xs">NYOMTATÁS</button>
                    </div>`;
                }).join('');
            }
        }

        function changeMonth(v) { date.setMonth(date.getMonth() + v); render(); }
        function addEmp() { const n = prompt("Név:"); if(n) { employees.push({id:Date.now(), name:n, yearlyQuota:160, data:{}}); save(); render(); initSortable(); } }
        function delEmp(id) { if(confirm("Törlés?")) { employees = employees.filter(x => x.id !== id); save(); render(); } }

        window.onload = () => changeShift(currentShift);
    </script>
</body>
</html>
